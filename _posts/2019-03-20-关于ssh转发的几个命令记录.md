---
layout: default
title: 关于ssh转发的几个命令记录
---

# {{ page.title }}

## 目标
有局域网一台centos 7， 互联网一台centos 7 vps，希望能在其他不能访问局域网的地方也能进入局域网。  

## 方法
本地 指局域网  
远程 指vps服务器  
### 1. 远程服务器添加一个最低权限的用户
-N 不设置默认组  
-g 指定组名  
-M 不创建home  
-s /bin/false 无法登陆shell  
`sudo useradd -N -g nobody -M -s /bin/false tom`  
实际上还是需要home目录的，登陆证书需要放在那儿。  

### 2. 远程转发
本地运行这个命令后，在远程服务器打开一个监听端口，在远程服务器上对这个监听端口的访问实际上就是对局域网内服务器对应端口的访问。  
-i 指定私钥  
-R 远程转发： 远程端口:本地映射的远程监听地址:本地端口  
-C compress  
-g gateway  
-f background  
-N no shell  
`ssh -i ~/.ssh/id_rsa_tom -R 1022:127.0.0.1:22 -CgfN tom@[ip] -p [port]`  
如果这个时候在远程服务器上ssh 1022端口，就登上了本地服务器。

### 3. 本地转发
-L 本地转发： 本地端口:远程地址:远程端口  
`ssh -i ~/.ssh/id_rsa_tom -L 13306:127.0.0.1:3306 -CgfN tom@[ip] -p [port]`  
如果这时候在本地局域网访问该服务器的13306端口，实际连上的就是远程服务器的MySQL。

### 4. 动态转发
-D 动态转发，相当于一个socks代理，这里用不上  

### 5. 实例
假设有局域网服务器192.168.1.2，互联网vps服务器 1.2.3.4  
1. 跨局域网远程shell登陆  
在192.168.1.2上执行：  
`ssh -p 1022 -R 9022:127.0.0.1:22 -CgfN tom@1.2.3.4`  
局域网外的某机器上执行：  
`ssh -p 1022 -L 11022:127.0.0.1:9022 -CgfN tom@1.2.3.4`  
再执行：  
`ssh me@127.0.0.1 -p 11022`  
这时登陆的就是192.168.1.2服务器了，后面2步改为直接登上vps服务器后ssh 127.0.0.1:9022也是可以的。

2. 跨局域网远程访问MySQL  
同上，在192.168.1.2上执行：  
`ssh -p 1022 -R 13306:127.0.0.1:3306 -CgfN tom@1.2.3.4`  
局域网外的某机器上执行：  
`ssh -p 1022 -L 23306:127.0.0.1:13306 -CgfN tom@1.2.3.4`  
然后此机器上的MySQL客户端连接127.0.0.1:23306即连接了192.168.1.2的MySQL服务。  
更多其他服务同理，采用-D动态转发更灵活，不过也更复杂点，原理都一样。
